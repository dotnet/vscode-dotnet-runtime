trigger: none
pr: none

parameters:
  - name: test
    type: boolean
    default: false

variables:
# This is expected to provide the PAT used to tag the release.
- group: DncEng-Partners-Tokens

resources:
  repositories:
  - repository: 1ESPipelineTemplates
    type: git
    name: 1ESPipelineTemplates/1ESPipelineTemplates
    ref: refs/tags/release
  pipelines:
  - pipeline: officialBuildCI
    source: dotnet-vscode-dotnet-runtime
    branch: main
extends:
  template: v1/1ES.Official.PipelineTemplate.yml@1ESPipelineTemplates
  parameters:
    pool:
      name: NetCore1ESPool-Internal
      image: 1es-windows-2022
      os: windows
    customBuildTags:
    - ES365AIMigrationTooling
    stages:
    - stage: PublishStage
      jobs:
      - deployment: PublishToMarketplace
        displayName: PublishToMarketplace
        environment: vscode-dotnetcore-extension-releases
        pool:
          name: NetCore1ESPool-Internal
          image: 1es-windows-2022
          os: windows
        templateContext:
          type: releaseJob
          isProduction: true
          inputs:
          - input: pipelineArtifact
            pipeline: officialBuildCI
            artifactName: vscode-dotnet-runtime-extension
            destinationPath: $(Pipeline.Workspace)
        strategy:
          runOnce:
            deploy:
              steps:
              - template: pipeline-templates/install-node.yaml@self
              - template: pipeline-templates/list-file-structure.yaml@self
              - bash: |
                  ARTIFACT_DIR="$(Pipeline.Workspace)"
                  VSIX_PATH=$(find "$ARTIFACT_DIR" -type f -name 'vscode-dotnet-runtime-*.vsix' | head -n 1)
                  if [ -z "$VSIX_PATH" ]; then
                    echo "##vso[task.logissue type=error]Unable to locate vscode-dotnet-runtime-*.vsix under $ARTIFACT_DIR"
                    exit 1
                  fi

                  FILE_NAME=$(basename "$VSIX_PATH")
                  VERSION=${FILE_NAME#vscode-dotnet-runtime-}
                  VERSION=${VERSION%.vsix}

                  echo "Using version $VERSION derived from artifact $FILE_NAME"

                  if [ -f package.json ]; then
                    npm version "$VERSION" --allow-same-version
                  fi

                  echo "##vso[task.setvariable variable=version;isOutput=true]$VERSION"
                name: GetVersion
                displayName: '‚ùì Get Version'
              - pwsh: |
                  npm install --global @vscode/vsce
                displayName: '‚¨áÔ∏è Install @vscode/vsce'
              - task: AzureCLI@2
                displayName: 'üöÄ Publish to Marketplace'
                inputs:
                  azureSubscription: 'VSCode Marketplace Publishing'
                  scriptType: "pscore"
                  scriptLocation: 'inlineScript'
                  workingDirectory: '$(System.ArtifactsDirectory)'
                  inlineScript: |
                    $basePublishArgs = , "publish"
                    $basePublishArgs += '--azure-credential'
                    $basePublishArgs += '--packagePath'
                    $publishArgs = $basePublishArgs + 'vscode-dotnet-runtime-$(GetVersion.version)-signed.vsix'
                    $publishArgs += '--manifestPath'
                    $publishArgs += 'vscode-dotnet-runtime-$(GetVersion.version).manifest'
                    $publishArgs += '--signaturePath'
                    $publishArgs += 'vscode-dotnet-runtime-$(GetVersion.version).signature.p7s'
                    $publishArgsString = $publishArgs -join ' '
                    If (${{ parameters.test }}) {
                      Write-Host "With a test-signed build, the command to publish is printed instead of run."
                      Write-Host "##[command]vsce $publishArgsString"

                      Write-Host "üîí Verify PAT."
                      vsce verify-pat --azure-credential ms-dotnettools
                    }
                    Else {
                      Write-Host "##[command]vsce $publishArgsString"
                    }