trigger:
  batch: true
  branches:
    include:
    - main
  tags:
    include:
    - SDK-v*
    - Runtime-v*
pr:
  autoCancel: false
  branches:
    include:
    - '*'

variables:
- name: Codeql.Enabled
  value: true

parameters:
- name: pools
  type: object
  default:
  - name: NetCore-Public
    vmImage: ubuntu-latest # The public PR pool schema is different from the 1ES one. We use 'vmImage' which is a default azure pipeline schema.
    os: linux
  - name: NetCore-Public
    vmImage: macOS-latest # 1ES uses 'image' but defining an image this way using our public pools does not work as they aren't configured this way.
    os: macOS
  - name: NetCore-Public
    vmImage: windows-latest # We add the flag 'oes' or one engineering system: false or true in all tasks to determine if we use vmImage or a 1es pool object.
    os: windows

stages:
- stage: o # o is just used so it looks like a bullet point in the output of devops
  jobs:
  - ${{ each image in parameters.pools }}:
    - template: pipeline-templates/build-test.yaml
      parameters:
        pool:
          vmImage: ${{ image.vmImage }}
          os: ${{ image.os }}
        oes: false
  - template: pipeline-templates/upstream-verify.yaml
    parameters:
      pool:
        vmImage: windows-latest
        os: windows
      oes: false
  - template: pipeline-templates/lint.yaml
    parameters:
      pool:
        vmImage: windows-latest
        os: windows
      oes: false
  - template: pipeline-templates/package-vsix.yaml
    parameters:
      pool:
        vmImage: windows-latest
        os: windows
      oes: false