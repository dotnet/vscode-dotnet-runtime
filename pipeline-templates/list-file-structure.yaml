parameters:
  - name: paths
    type: object
    default:
      - path: $(System.DefaultWorkingDirectory)
        title: "üè† SYSTEM DEFAULT WORKING DIRECTORY"
      - path: $(Build.ArtifactStagingDirectory)
        title: "üéØ BUILD ARTIFACT STAGING DIRECTORY"
  - name: displayName
    type: string
    default: 'üìã List All Files Recursively'

steps:
  - ${{ each pathConfig in parameters.paths }}:
    - pwsh: |
        Write-Host "====================== FILE STRUCTURE OVERVIEW ======================"
        Write-Host ""

        # Function to create a tree-like structure
        function Show-DirectoryTree {
          param(
            [string]$Path,
            [string]$Title,
            [string]$Prefix = ""
          )

          Write-Host "$Title" -ForegroundColor Cyan
          Write-Host "Path: $Path" -ForegroundColor Yellow
          Write-Host ""

          if (Test-Path $Path) {
            try {
              $items = Get-ChildItem -Path $Path -Recurse | Sort-Object FullName
              $totalFiles = ($items | Where-Object { -not $_.PSIsContainer }).Count
              $totalDirs = ($items | Where-Object { $_.PSIsContainer }).Count

              Write-Host "üìä Summary: $totalDirs directories, $totalFiles files" -ForegroundColor Green
              Write-Host ""

              # Group by directory for better structure
              $directories = $items | Where-Object { $_.PSIsContainer } | Sort-Object FullName
              $files = $items | Where-Object { -not $_.PSIsContainer } | Sort-Object FullName

              # Show directory structure first
              if ($directories.Count -gt 0) {
                Write-Host "üìÅ Directory Structure:" -ForegroundColor Magenta
                foreach ($dir in $directories) {
                  $relativePath = $dir.FullName.Replace($Path, "").TrimStart('\', '/')
                  $depth = ($relativePath.Split('\', '/') | Where-Object { $_ -ne "" }).Count
                  $indent = "  " * $depth + "‚îú‚îÄ‚îÄ "
                  Write-Host "$indent$($dir.Name)/" -ForegroundColor Blue
                }
                Write-Host ""
              }

              # Show files grouped by directory
              Write-Host "üìÑ Files:" -ForegroundColor Magenta
              $filesByDir = $files | Group-Object { Split-Path $_.FullName -Parent }

              foreach ($group in ($filesByDir | Sort-Object Name)) {
                $relativeDirPath = $group.Name.Replace($Path, "").TrimStart('\', '/')
                if ($relativeDirPath -eq "") {
                  Write-Host "  üìÇ Root:" -ForegroundColor Yellow
                } else {
                  Write-Host "  üìÇ $relativeDirPath:" -ForegroundColor Yellow
                }

                foreach ($file in ($group.Group | Sort-Object Name)) {
                  $size = if ($file.Length -lt 1KB) { "$($file.Length) B" }
                         elseif ($file.Length -lt 1MB) { "{0:N1} KB" -f ($file.Length / 1KB) }
                         else { "{0:N1} MB" -f ($file.Length / 1MB) }

                  Write-Host "    ‚îú‚îÄ‚îÄ $($file.Name) ($size)" -ForegroundColor White
                }
                Write-Host ""
              }
            }
            catch {
              Write-Host "‚ùå Error accessing directory: $_" -ForegroundColor Red
            }
          } else {
            Write-Host "‚ùå Directory does not exist" -ForegroundColor Red
          }
          Write-Host "=================================================================" -ForegroundColor Cyan
          Write-Host ""
        }

        # Process the current path
        Show-DirectoryTree -Path "${{ pathConfig.path }}" -Title "${{ pathConfig.title }}"

      displayName: '${{ parameters.displayName }} - ${{ pathConfig.title }}'
