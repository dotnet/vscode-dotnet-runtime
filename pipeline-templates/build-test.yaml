parameters:
  pool: ''

jobs:
- job: ${{ parameters.pool.os }}_Build
  pool:
    ${{ if eq(parameters.useOneEngineeringPool, 'true') }}:
        ${{ parameters.pool }}
    ${{ else }}:
        vmImage: ${{ parameters.pool.vmImage }}

  displayName: '${{ parameters.pool.emoji }} ${{ parameters.pool.os }} Build and Test'
  templateContext:
    outputs:
    - output: pipelineArtifact
      displayName: 'ğŸŒ Publish Install Tool Logs'
      condition: always()
      targetPath: '$(Build.SourcesDirectory)/vscode-dotnet-runtime-extension/dist/test/functional/logs'
      artifactName: '${{ parameters.pool.os }} Install Tool logs'
    - output: pipelineArtifact
      displayName: 'ğŸ‘œ Publish SDK Logs'
      condition: always()
      targetPath: '$(Build.SourcesDirectory)/vscode-dotnet-sdk-extension/dist/test/functional/logs'
      artifactName: '${{ parameters.pool.os }} SDK logs'
  steps:
  - template: install-node.yaml
  - ${{ if eq(parameters.pool.os, 'windows') }}:
    - script: build.cmd
      displayName: ğŸ’» Build Windows
      condition:
    - script: test.cmd
      displayName: ğŸ” Test Windows
  - ${{ if eq(parameters.pool.os, 'linux') }}:
    - bash: |
        /usr/bin/Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
        echo ">>> Started xvfb"
      displayName: ğŸ® Start xvfb
  - ${{ if or(eq(parameters.pool.os, 'macOS'), eq(parameters.pool.os, 'linux')) }}:
    - script: ./build.sh
      displayName: ğŸ§ Build Mac and Linux
      condition:
    - script: ./test.sh
      displayName: ğŸ” Test Mac and Linux
      env: {DISPLAY: ':99.0'}
  - template: component-governance.yaml
    parameters:
      pool: ${{ parameters.pool }}
      SignType: ${{ parameters.SignType }}
      useOneEngineeringPool: ${{ parameters.useOneEngineeringPool }}